<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Paean Blog Website">
    <meta name="author" content="ABTech">
    <title>Paean | Blog Post</title>

    <link rel="icon" href="./public_html/assets/imgs/logo.png" type="image/gif" />
    <meta property="og:title" content="Paean Blog Website">
    <meta property="og:description" content="This is the official website for Paean Blog Posts">
    <meta property="og:image" content="./public_html/assets/imgs/logo.png">
    <meta property="og:url" content="https://paean.vercel.app">
    <meta property="og:type" content="Blogs">
    <!-- font icons -->
    <link rel="stylesheet" href="./public_html/assets/vendors/themify-icons/css/themify-icons.css">
    <!-- Bootstrap + JoeBLog main styles -->
    <link rel="stylesheet" href="./public_html/assets/css/joeblog.css">
</head>

<body data-spy="scroll" data-target=".navbar" data-offset="40" id="home">

    <!-- Page Second Navigation -->
    <nav class="navbar custom-navbar navbar-expand-md navbar-light bg-primary sticky-top">
        <div class="container">
            <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse"
                data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- End Of Page Second Navigation -->

    <!-- Page Header -->
    <header class="page-header page-header-mini">
        <h1 class="title">Contented Blogs</h1>
        <ol class="breadcrumb pb-0">
            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Paean Blog</li>
        </ol>
    </header>
    <!-- End Of Page Header -->

    <section class="container">
        <div class="page-container">
            <div class="page-content">
                <div id="mainContent">
                    
                </div>

                <h6 class="mt-5 text-center">Related Posts</h6>
                <hr>
                <div class="row" id="populationThree">
                    <!-- <div class="col-md-6 col-lg-4">
                        
                    </div> -->
                </div>
            </div>
            <!-- Sidebar -->
            <div class="page-sidebar">
                <h6 class=" ">Tags</h6>
                <div id="tagsIn"></div>
                
                <div class="ad-card d-flex text-center align-items-center justify-content-center mt-4">
                    <span href="#" class="font-weight-bold">ADS</span>
                </div>
            </div>
        </div>
    </section>

    <div class="instaPosters" id="instaPosters">

        <div class="instagram-wrapper mt-5">
            <div class="ig-id">
                <a href="https://www.instagram.com/akinwumi8767?igsh=YzljYTk1ODg3Zg==">Follow Paean On Instagram</a>
            </div>
        </div>
    </div>

    <!-- Page Footer -->
    <footer class="page-footer">
        <div class="container">
            <div class="row align-items-center justify-content-between">
                <div class="col-md-3 text-center text-md-left mb-3 mb-md-0">
                    <img src="./public_html/assets/imgs/logo.png" alt="" class="logo">
                </div>
                <div class="col-md-9 text-center text-md-right">
                    <div class="socials">
                        <a href="https://www.facebook.com/akinleyeakin?mibextid=rS40aB7S9Ucbxw6v" class="font-weight-bold text-muted mr-4"><i class="ti-facebook pr-1"></i> 123,345</a>
                        <a href="https://x.com/kinzos?t=eOGIy22N1Kpq6bgtlWbxnQ&s=08" class="font-weight-bold text-muted mr-4"><i class="ti-twitter pr-1"></i> 321,534</a>
                        <!-- <a href="javascript:void(0)" class="font-weight-bold text-muted mr-4"><i class="ti-pinterest-alt pr-1"></i> 543,312</a> -->
                        <a href="https://www.instagram.com/akinwumi8767?igsh=YzljYTk1ODg3Zg==" class="font-weight-bold text-muted mr-4"><i class="ti-instagram pr-1"></i> 123,023</a>
                        <!-- <a href="javascript:void(0)" class="font-weight-bold text-muted mr-4"><i class="ti-youtube pr-1"></i> 231,043</a> -->
                    </div>
                </div>  
            </div>
            <p class="border-top mb-0 mt-4 pt-3 small">&copy; <script>document.write(new Date().getFullYear())</script>, ABTech Created By <a href="https://www.abtech-two.vercel.app" class="text-muted font-weight-bold" target="_blank">ABTech.</a>  All rights reserved </p> 
        </div>      
    </footer>
    <!-- End of Page Footer -->

    <!-- core  -->
    <script src="./public_html/assets/vendors/jquery/jquery-3.4.1.js"></script>
    <script src="./public_html/assets/vendors/bootstrap/bootstrap.bundle.js"></script>

    <!-- JoeBLog js -->
    <script src="./public_html/assets/js/joeblog.js"></script>
    <script type="module" src="app.js"></script>





    <script type="module">
        // THE CONTENTS SPEARHEAD
        import { createClient } from 'https://esm.sh/@supabase/supabase-js';

        const supabaseUrl = 'https://opjxgfjfjvcexhizvyar.supabase.co';
        const supabaseKey =
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wanhnZmpmanZjZXhoaXp2eWFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI3ODMzMTUsImV4cCI6MjA0ODM1OTMxNX0.Vx5dbIopGNk2EU825CEPSVU5fIrlBp0d2yJi1fL_A80';

        const supabase = createClient(supabaseUrl, supabaseKey);

        // http://127.0.0.1:5500/single-post.html?slug=the-new-test
        // GET SLUG FROM THE URL
        let mainContent = document.getElementById('mainContent')
        const urlParameters = new URLSearchParams(window.location.search)
        const slug = urlParameters.get('slug')

        // FUNCTION TO FETCH THE BLOGS
        const readBlog = async () => {
            const {data, error} = await supabase
            .from('BLOGS')
            .select(`
                *,
                COMMENTS(*)
            `)
            .eq('Slug', slug)

            if(error){
            console.error(error)
            }else{

                let blogAuthor = data[0].blogAuthor
                let blogContent = data[0].blogContent
                let blogDate = data[0].blogDate
                let blogImage = data[0].blogImage
                let blogTitle = data[0].blogTitle
                let blogCategory = data[0].blogCategory
                let blogIdFetched = data[0].id
                let slugFetched = data[0].Slug

                // console.log(data)


                let blogCommentss = data[0].COMMENTS


                let newDiv = document.createElement('div')
                newDiv.setAttribute('class', 'card')
                newDiv.innerHTML = `

                <div class="card-header pt-0">
                        <h3 class="card-title mb-4">${blogTitle}</h3>
                        <div class="blog-media mb-4">
                            <img src="${blogImage}" alt="" class="w-100">
                            <a href="#" class="badge badge-primary">${blogCategory}</a>
                        </div>
                        <small class="small text-muted">
                            <a href="#" class="text-muted">BY ${blogAuthor}</a>
                            <span class="px-2">·</span>
                            <span>"${blogDate}</span>
                            <span class="px-2">·</span>
                            
                        </small>
                    </div>
                    <div class="card-body border-top">
                        <p class="my-3">${blogContent}</p>
                    </div>

                    <h6 class="mt-5 mb-3 text-center"><a href="#" class="text-dark">Comments</a></h6>
                    <div id="commentDisplayBox">
                        
                    </div>

                        
                        <h6 class="mt-5 mb-3 text-center"><a href="#" class="text-dark">Write Your Comment</a></h6>
                        <hr>
                        <div>
                            <div class="form-row">
                                <div class="col-12 form-group">
                                    <textarea name="" id="" cols="30" rows="10" class="form-control"
                                        placeholder="Enter Your Comment Here"></textarea>
                                        <input type="text" class="commenterName" placeholder="Name" style="width: 300px; border: none;">
                                        <button class="btn btn-primary btn-block">Post Comment</button>
                                        <button class="share btn-primary btn-block" style="background-color: rgb(58, 58, 182); color: white;">Share Post</button>
                                </div>
                            </div>
                        </div>
                    </div>
                             
                `

                mainContent.appendChild(newDiv)



                    // SHARING THE BLOG
            newDiv.querySelector('.share').addEventListener('click', () => {
                    blogURL(slugFetched)
            })

            // FETCHING THE BLOG COMMENT
                let commentDisplayBox = document.querySelector('#commentDisplayBox')
                blogCommentss.forEach(commentElement => {
                    let newCommentDiv = document.createElement('div')
                    newCommentDiv.setAttribute('class', 'card-footer')
                    newCommentDiv.innerHTML = `
                    
                            <hr>
                            <div class="media">
                                <img src="./public_html/assets/imgs/profile.png" class="mr-3 thumb-sm rounded-circle"
                                    alt="...">
                            <div class="media-body">
                                    <h6 class="mt-0">${commentElement.commenterName}</h6>
                                    <p>${commentElement.theComment}</p>
                            </div>
                    
                    
                    `
                    commentDisplayBox.appendChild(newCommentDiv)
                });

                // COMMENTING ON THE BLOG
                newDiv.querySelector('.btn').addEventListener('click', async (event) => {
                    const commentSection = event.target.closest('.col-12')
                    
                    const mainCommentInput = commentSection.querySelector('.form-control');
                    const commentNameInput = commentSection.querySelector('.commenterName');
                
                    const mainComment = mainCommentInput.value;
                    const commentName = commentNameInput.value;
                    
                    console.log('comment name:', commentName);
                    console.log('comment:', mainComment);

                     // Ensuring the values are passed correctly
                    if (mainComment && commentName) {
                        const isSuccessful = await sendComment(mainComment, commentName, blogIdFetched);
                
                        if (isSuccessful) {
                            // Clear the fields after successful comment submission
                            mainCommentInput.value = '';
                            commentNameInput.value = '';
                        }
                    } else {
                        console.error('Comment or Name is empty!');
                    }
                    
                })
                
            // console.log(data);
            }
        }


        
//  SENDING COMMENT

    const sendComment = async(mainComment, commentName, blogIdFetched) => {
        const {data, error} = await supabase
        .from('COMMENTS')
        .insert([
            {
                commenterName : commentName,
                theComment : mainComment,
                blog_id : blogIdFetched
            }
        ])
        if(error){
            alert(error.message)
            console.error(error)
            return false;
        }else{
            alert('comment made')
            console.log('Comment made', data);
            return true;
        }
    }


    // SHARING THE POST
    function blogURL(slugFetched){
        const redirectUrl = `${window.location.origin}/single-post.html?slug=${slugFetched}`
        navigator.clipboard.writeText(redirectUrl)
        .then(() => {
            alert('Blog link Copied')
        })
        .catch(error => {
            console.error(error)
        })
    }





        readBlog()


// FETCHING THE CATEGORIES
let tagsIn = document.getElementById('tagsIn')
        const fetchAllCategories = async () => {
            const { data, error } = await supabase
            .from('BLOGS')
            .select('blogCategory')
            // .distinct(); 

            if (error) {
                console.error('Error fetching categories:', error);
                return [];
            }

                // console.log('Categories:', data);
                return data; 
            };

            // Usage
            fetchAllCategories()
            .then((categories) => {
            // Handle the categories data
            categories.forEach(category => {
                let newTag = document.createElement('div')
                newTag.innerHTML = `
                    <a href="${window.location.origin}/relevantTags.html?category=${category.blogCategory}" class="badge badge-primary m-1">${category.blogCategory}</a>
                `
                // console.log(category.blogCategory)
                tagsIn.appendChild(newTag)
            }
        );
        });

        fetchAllCategories()

        // single-post.html?slug=${element.Slug}



    </script>

</body>

</html>